var k=Object.create,C=Object.defineProperty,I=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty,D=Object.getOwnPropertyNames,P=Object.getOwnPropertyDescriptor;var L=s=>C(s,"__esModule",{value:!0});var M=(s,e)=>()=>(e||(e={exports:{}},s(e.exports,e)),e.exports);var q=(s,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of D(e))!O.call(s,i)&&i!=="default"&&C(s,i,{get:()=>e[i],enumerable:!(t=P(e,i))||t.enumerable});return s},x=s=>s&&s.__esModule?s:q(L(C(s!=null?k(I(s)):{},"default",{value:s,enumerable:!0})),s);var T=M((K,b)=>{"use strict";var U=Object.prototype.hasOwnProperty,f="~";function m(){}Object.create&&(m.prototype=Object.create(null),new m().__proto__||(f=!1));function F(s,e,t){this.fn=s,this.context=e,this.once=t||!1}function R(s,e,t,i,r){if(typeof t!="function")throw new TypeError("The listener must be a function");var n=new F(t,i||s,r),c=f?f+e:e;return s._events[c]?s._events[c].fn?s._events[c]=[s._events[c],n]:s._events[c].push(n):(s._events[c]=n,s._eventsCount++),s}function y(s,e){--s._eventsCount==0?s._events=new m:delete s._events[e]}function u(){this._events=new m,this._eventsCount=0}u.prototype.eventNames=function(){var e=[],t,i;if(this._eventsCount===0)return e;for(i in t=this._events)U.call(t,i)&&e.push(f?i.slice(1):i);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};u.prototype.listeners=function(e){var t=f?f+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,n=i.length,c=new Array(n);r<n;r++)c[r]=i[r].fn;return c};u.prototype.listenerCount=function(e){var t=f?f+e:e,i=this._events[t];return i?i.fn?1:i.length:0};u.prototype.emit=function(e,t,i,r,n,c){var _=f?f+e:e;if(!this._events[_])return!1;var a=this._events[_],o=arguments.length,l,h;if(a.fn){switch(a.once&&this.removeListener(e,a.fn,void 0,!0),o){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,t),!0;case 3:return a.fn.call(a.context,t,i),!0;case 4:return a.fn.call(a.context,t,i,r),!0;case 5:return a.fn.call(a.context,t,i,r,n),!0;case 6:return a.fn.call(a.context,t,i,r,n,c),!0}for(h=1,l=new Array(o-1);h<o;h++)l[h-1]=arguments[h];a.fn.apply(a.context,l)}else{var S=a.length,p;for(h=0;h<S;h++)switch(a[h].once&&this.removeListener(e,a[h].fn,void 0,!0),o){case 1:a[h].fn.call(a[h].context);break;case 2:a[h].fn.call(a[h].context,t);break;case 3:a[h].fn.call(a[h].context,t,i);break;case 4:a[h].fn.call(a[h].context,t,i,r);break;default:if(!l)for(p=1,l=new Array(o-1);p<o;p++)l[p-1]=arguments[p];a[h].fn.apply(a[h].context,l)}}return!0};u.prototype.on=function(e,t,i){return R(this,e,t,i,!1)};u.prototype.once=function(e,t,i){return R(this,e,t,i,!0)};u.prototype.removeListener=function(e,t,i,r){var n=f?f+e:e;if(!this._events[n])return this;if(!t)return y(this,n),this;var c=this._events[n];if(c.fn)c.fn===t&&(!r||c.once)&&(!i||c.context===i)&&y(this,n);else{for(var _=0,a=[],o=c.length;_<o;_++)(c[_].fn!==t||r&&!c[_].once||i&&c[_].context!==i)&&a.push(c[_]);a.length?this._events[n]=a.length===1?a[0]:a:y(this,n)}return this};u.prototype.removeAllListeners=function(e){var t;return e?(t=f?f+e:e,this._events[t]&&y(this,t)):(this._events=new m,this._eventsCount=0),this};u.prototype.off=u.prototype.removeListener;u.prototype.addListener=u.prototype.on;u.prefixed=f;u.EventEmitter=u;typeof b!="undefined"&&(b.exports=u)});var E=x(T());var v=64*1024,j=5*1e3,B=5*1e3;function A(s){let e=new Uint8Array(s);for(let t=0;t<s;t++)e[t]=Math.random()*256|0;return e}function w(){if(typeof globalThis=="undefined")return null;let s={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return s.RTCPeerConnection?s:null}function d(s,e){return Object.defineProperty(s,"code",{value:e,enumerable:!0,configurable:!0}),s}function N(s){return s.replace(/a=ice-options:trickle\s\n/g,"")}function H(s){console.warn(s)}var g=class extends E.default{constructor(e={}){super();if(this._id=A(4).toString("hex").slice(0,7),this._doDebug=e.debug,this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||A(20).toString("hex"):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||g.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},g.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(t=>t),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=e.trickle!==void 0?e.trickle:!0,this.allowHalfTrickle=e.allowHalfTrickle!==void 0?e.allowHalfTrickle:!1,this.iceCompleteTimeout=e.iceCompleteTimeout||j,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&typeof e.wrtc=="object"?e.wrtc:w(),!this._wrtc)throw typeof window=="undefined"?d(new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):d(new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(t){queueMicrotask(()=>this.destroy(d(t,"ERR_PC_CONSTRUCTOR")));return}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=t=>{this._onIceCandidate(t)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=t=>{this._setupData(t)},this.streams&&this.streams.forEach(t=>{this.addStream(t)}),this._pc.ontrack=t=>{this._onTrack(t)},this._debug("initial negotiation"),this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(this.destroyed)throw d(new Error("cannot signal after peer is destroyed"),"ERR_SIGNALING");if(typeof e=="string")try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(t=>{this._addIceCandidate(t)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer())}).catch(t=>{this.destroy(d(t,"ERR_SET_REMOTE_DESCRIPTION"))}),!e.sdp&&!e.candidate&&!e.renegotiate&&!e.transceiverRequest&&this.destroy(d(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}_addIceCandidate(e){let t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch(i=>{!t.address||t.address.endsWith(".local")?H("Ignoring unsupported ICE candidate."):this.destroy(d(i,"ERR_ADD_ICE_CANDIDATE"))})}send(e){this._channel.send(e)}addTransceiver(e,t){if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(i){this.destroy(d(i,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}addStream(e){this._debug("addStream()"),e.getTracks().forEach(t=>{this.addTrack(t,e)})}addTrack(e,t){this._debug("addTrack()");let i=this._senderMap.get(e)||new Map,r=i.get(t);if(!r)r=this._pc.addTrack(e,t),i.set(t,r),this._senderMap.set(e,i),this._needsNegotiation();else throw r.removed?d(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):d(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}replaceTrack(e,t,i){this._debug("replaceTrack()");let r=this._senderMap.get(e),n=r?r.get(i):null;if(!n)throw d(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,r),n.replaceTrack!=null?n.replaceTrack(t):this.destroy(d(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){this._debug("removeSender()");let i=this._senderMap.get(e),r=i?i.get(t):null;if(!r)throw d(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{r.removed=!0,this._pc.removeTrack(r)}catch(n){n.name==="NS_ERROR_UNEXPECTED"?this._sendersAwaitingStable.push(r):this.destroy(d(n,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){this._debug("removeSenders()"),e.getTracks().forEach(t=>{this.removeTrack(t,e)})}_needsNegotiation(){this._debug("_needsNegotiation"),!this._batchedNegotiation&&(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}destroy(e){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),queueMicrotask(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",e&&(e.message||e)),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(t){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(t){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}))}_setupData(e){if(!e.channel)return this.destroy(d(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=v),this.channelName=this._channel.label,this._channel.onmessage=i=>{this._onChannelMessage(i)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=i=>{this.destroy(d(i,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(t&&this._onChannelClose(),t=!0):t=!1},B)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=N(e.sdp)),e.sdp=this.sdpTransform(e.sdp);let t=()=>{if(this.destroyed)return;let n=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:n.type,sdp:n.sdp})},i=()=>{this._debug("createOffer success"),!this.destroyed&&(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))},r=n=>{this.destroy(d(n,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(i).catch(r)}).catch(e=>{this.destroy(d(e,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(e=>{!e.mid&&e.sender.track&&!e.requested&&(e.requested=!0,this.addTransceiver(e.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=N(e.sdp)),e.sdp=this.sdpTransform(e.sdp);let t=()=>{if(this.destroyed)return;let n=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:n.type,sdp:n.sdp}),this.initiator||this._requestMissingTransceivers()},i=()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))},r=n=>{this.destroy(d(n,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(i).catch(r)}).catch(e=>{this.destroy(d(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._pc.connectionState==="failed"&&this.destroy(d(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;let e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),(e==="connected"||e==="completed")&&(this._pcReady=!0,this._maybeReady()),e==="disconnected"&&this.emit("disconnect"),e==="failed"&&this.destroy(d(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),e==="closed"&&this.destroy(d(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){let t=i=>(Object.prototype.toString.call(i.values)==="[object Array]"&&i.values.forEach(r=>{Object.assign(i,r)}),i);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then(i=>{let r=[];i.forEach(n=>{r.push(t(n))}),e(null,r)},i=>e(i)):this._pc.getStats.length>0?this._pc.getStats(i=>{if(this.destroyed)return;let r=[];i.result().forEach(n=>{let c={};n.names().forEach(_=>{c[_]=n.stat(_)}),c.id=n.id,c.type=n.type,c.timestamp=n.timestamp,r.push(t(c))}),e(null,r)},i=>e(i)):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;let e=()=>{this.destroyed||this.getStats((t,i)=>{if(this.destroyed)return;t&&(i=[]);let r={},n={},c={},_=!1;i.forEach(o=>{(o.type==="remotecandidate"||o.type==="remote-candidate")&&(r[o.id]=o),(o.type==="localcandidate"||o.type==="local-candidate")&&(n[o.id]=o),(o.type==="candidatepair"||o.type==="candidate-pair")&&(c[o.id]=o)});let a=o=>{_=!0;let l=n[o.localCandidateId];l&&(l.ip||l.address)?(this.localAddress=l.ip||l.address,this.localPort=Number(l.port)):l&&l.ipAddress?(this.localAddress=l.ipAddress,this.localPort=Number(l.portNumber)):typeof o.googLocalAddress=="string"&&(l=o.googLocalAddress.split(":"),this.localAddress=l[0],this.localPort=Number(l[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let h=r[o.remoteCandidateId];h&&(h.ip||h.address)?(this.remoteAddress=h.ip||h.address,this.remotePort=Number(h.port)):h&&h.ipAddress?(this.remoteAddress=h.ipAddress,this.remotePort=Number(h.portNumber)):typeof o.googRemoteAddress=="string"&&(h=o.googRemoteAddress.split(":"),this.remoteAddress=h[0],this.remotePort=Number(h[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(i.forEach(o=>{o.type==="transport"&&o.selectedCandidatePairId&&a(c[o.selectedCandidatePairId]),(o.type==="googCandidatePair"&&o.googActiveConnection==="true"||(o.type==="candidatepair"||o.type==="candidate-pair")&&o.selected)&&a(o)}),!_&&(!Object.keys(c).length||Object.keys(n).length)){setTimeout(e,100);return}else this._connecting=!1,this._connected=!0;if(this._chunk){try{this.send(this._chunk)}catch(l){return this.destroy(d(l,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');let o=this._cb;this._cb=null,o(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>v||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||(this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):!e.candidate&&!this._iceComplete&&(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=new Uint8Array(t)),this.emit("data",t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);let e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(e){this.destroyed||e.streams.forEach(t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),!this._remoteStreams.some(i=>i.id===t.id)&&(this._remoteStreams.push(t),queueMicrotask(()=>{this._debug("on stream"),this.emit("stream",t)}))})}_debug(...e){!this._doDebug||(e[0]="["+this._id+"] "+e[0],console.log(...e))}};g.WEBRTC_SUPPORT=!!w();g.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"};g.channelConfig={};var W=g;export{W as default};
/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
//# sourceMappingURL=simple-peer-light.min.js.map
